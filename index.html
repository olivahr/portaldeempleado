<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Employee Portal | Sign in</title>

  <link rel="stylesheet" href="./assets/app.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<body class="app-bg">
  <div class="auth-wrap">
    <div class="auth-card">

      <div class="brand">
        <div class="brand-dot"></div>
        <div>
          <div class="brand-title">Employee Portal</div>
          <div class="brand-sub">Sign in to continue</div>
        </div>
      </div>

      <div class="alert warn" id="firebaseNotice" style="display:none;">
        Firebase is not configured yet.
      </div>

      <label class="lbl">Email</label>
      <input id="email" class="inp" type="email" placeholder="name@email.com" autocomplete="username"/>

      <label class="lbl">Password</label>
      <input id="pass" class="inp" type="password" placeholder="••••••••" autocomplete="current-password"/>

      <button id="btnLogin" class="btn primary" type="button">Sign in</button>

      <div class="row">
        <button id="btnGoogle" class="btn ghost" type="button">Sign in with Google</button>
        <button id="btnReset" class="btn ghost" type="button">Forgot password</button>
      </div>

      <div class="sep"></div>

      <div class="small">
        New here?
        <button id="btnRegister" class="linkbtn" type="button">Create account</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <div class="auth-foot">
      © <span id="year"></span> Employee Portal
    </div>
  </div>

<script type="module">
  // UI helpers
  import { uiSetText, uiShow, uiToast } from "./assets/ui.js";

  // Auth helpers
  import {
    authReady,
    signInEmail,
    signInGoogle,
    registerEmail,
    resetPassword
  } from "./assets/auth.js";

  // Firebase
  import { auth, db, isFirebaseConfigured } from "./assets/firebase.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- DOM ----
  const yearEl = document.getElementById("year");
  const msg = document.getElementById("msg");
  const firebaseNotice = document.getElementById("firebaseNotice");
  const emailEl = document.getElementById("email");
  const passEl  = document.getElementById("pass");

  const btnLogin = document.getElementById("btnLogin");
  const btnRegister = document.getElementById("btnRegister");
  const btnReset = document.getElementById("btnReset");
  const btnGoogle = document.getElementById("btnGoogle");

  yearEl.textContent = new Date().getFullYear();

  // ---- Small utils ----
  function showErr(e){
    uiSetText(msg, e?.message || String(e));
  }

  function setBusy(isBusy){
    btnLogin.disabled = isBusy;
    btnRegister.disabled = isBusy;
    btnReset.disabled = isBusy;
    btnGoogle.disabled = isBusy;

    btnLogin.textContent = isBusy ? "Signing in..." : "Sign in";
  }

  // Routes
  const EMPLOYEE_DEFAULT_URL = "./employee.html#progress";
  const ADMIN_URL = "./admin.html";

  // Optional: remember “where user tried to go”
  // If later you add protected routes, you can set this before redirecting to index.html
  const intent = sessionStorage.getItem("postLoginIntent") || "";

  function goEmployee(){
    const next = (intent && intent.startsWith("./employee.html"))
      ? intent
      : EMPLOYEE_DEFAULT_URL;

    sessionStorage.removeItem("postLoginIntent");
    window.location.href = next;
  }

  function goAdmin(){
    sessionStorage.removeItem("postLoginIntent");
    window.location.href = ADMIN_URL;
  }

  // ---- Firebase readiness ----
  try{
    const ok = await authReady();
    if (!ok) uiShow(firebaseNotice, true);
  }catch{
    uiShow(firebaseNotice, true);
  }

  // ✅ ADMIN CHECK (safe, never blocks)
  async function goNextByRole(){
    // Preview mode → employee (never block)
    try{
      if (typeof isFirebaseConfigured === "function" && !isFirebaseConfigured()){
        goEmployee();
        return;
      }
    }catch{
      goEmployee();
      return;
    }

    const user = auth?.currentUser;
    if (!user){
      goEmployee();
      return;
    }

    try{
      // admins/{uid} { role:"admin" } OR { isAdmin:true }
      const ref = doc(db, "admins", user.uid);
      const snap = await getDoc(ref);

      const d = snap.exists() ? (snap.data() || {}) : {};
      const isAdmin = snap.exists() && (d.role === "admin" || d.isAdmin === true);

      // If intent asks for admin but user is not admin → ignore and send employee
      if (intent && intent.startsWith("./admin.html") && !isAdmin){
        goEmployee();
        return;
      }

      isAdmin ? goAdmin() : goEmployee();
    }catch{
      // Firestore failed / rules / offline → don’t block login
      goEmployee();
    }
  }

  // ---- Actions ----
  async function doLogin(){
    uiSetText(msg, "");
    setBusy(true);
    try{
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      if(!email || !pass) throw new Error("Enter email and password.");
      await signInEmail(email, pass);
      await goNextByRole();
    }catch(e){
      showErr(e);
      setBusy(false);
    }
  }

  async function doRegister(){
    uiSetText(msg, "");
    setBusy(true);
    try{
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      if(!email) throw new Error("Enter your email.");
      if(pass.length < 6) throw new Error("Password min 6 characters.");
      await registerEmail(email, pass);
      uiToast("Account created");
      await goNextByRole();
    }catch(e){
      showErr(e);
      setBusy(false);
    }
  }

  async function doReset(){
    uiSetText(msg, "");
    setBusy(true);
    try{
      const email = emailEl.value.trim();
      if(!email) throw new Error("Enter email first.");
      await resetPassword(email);
      uiToast("Reset email sent");
      setBusy(false);
    }catch(e){
      showErr(e);
      setBusy(false);
    }
  }

  async function doGoogle(){
    uiSetText(msg, "");
    setBusy(true);
    try{
      await signInGoogle();
      await goNextByRole();
    }catch(e){
      showErr(e);
      setBusy(false);
    }
  }

  // ---- Wires ----
  btnLogin.addEventListener("click", doLogin);
  btnRegister.addEventListener("click", doRegister);
  btnReset.addEventListener("click", doReset);
  btnGoogle.addEventListener("click", doGoogle);

  // Enter key → login (Safari safe)
  passEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      doLogin();
    }
  });
</script>

</body>
</html>
