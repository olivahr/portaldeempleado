<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Employee Portal | Sign in</title>

  <link rel="stylesheet" href="./assets/app.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<body class="app-bg">

  <div class="auth-wrap">
    <div class="auth-card">

      <div class="brand">
        <div class="brand-dot"></div>
        <div>
          <div class="brand-title">Employee Portal</div>
          <div class="brand-sub">Sign in to continue</div>
        </div>
      </div>

      <div class="alert warn" id="firebaseNotice" style="display:none;">
        Firebase is not configured yet.
      </div>

      <label class="lbl">Email</label>
      <input id="email" class="inp" placeholder="name@email.com"/>

      <label class="lbl">Password</label>
      <input id="pass" class="inp" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>

      <button id="btnLogin" class="btn primary">Sign in</button>

      <div class="row">
        <button id="btnGoogle" class="btn ghost">Sign in with Google</button>
        <button id="btnReset" class="btn ghost">Forgot password</button>
      </div>

      <div class="sep"></div>

      <div class="small">
        New here?
        <button id="btnRegister" class="linkbtn">Create account</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <div class="auth-foot">
      Â© <span id="year"></span> Employee Portal
    </div>
  </div>


<script type="module">

// UI helpers
import { uiSetText, uiShow, uiToast } from "./assets/ui.js";

// Auth helpers
import { 
  authReady, 
  signInEmail, 
  signInGoogle, 
  registerEmail, 
  resetPassword 
} from "./assets/auth.js";

// Firebase
import { auth, db } from "./assets/firebase.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

document.getElementById("year").textContent = new Date().getFullYear();

const msg = document.getElementById("msg");
const firebaseNotice = document.getElementById("firebaseNotice");

const emailEl = document.getElementById("email");
const passEl  = document.getElementById("pass");

// Check Firebase
const ok = await authReady();
if (!ok) uiShow(firebaseNotice, true);

// ðŸ”¥ ADMIN CHECK
async function goNextByRole() {

  const user = auth.currentUser;

  if (!user) {
    window.location.href = "./employee.html";
    return;
  }

  const ref = doc(db, "admins", user.uid);
  const snap = await getDoc(ref);

  if (snap.exists() && snap.data()?.role === "admin") {
    window.location.href = "./admin.html";
  } else {
    window.location.href = "./employee.html";
  }
}

// LOGIN
async function doLogin() {
  uiSetText(msg,"");

  try {
    await signInEmail(
      emailEl.value.trim(),
      passEl.value.trim()
    );

    await goNextByRole();

  } catch(e) {
    uiSetText(msg, e.message);
  }
}

// REGISTER
async function doRegister() {
  uiSetText(msg,"");

  try {
    const pass = passEl.value.trim();

    if(pass.length < 6)
      throw new Error("Password min 6 characters");

    await registerEmail(
      emailEl.value.trim(),
      pass
    );

    uiToast("Account created");
    await goNextByRole();

  } catch(e) {
    uiSetText(msg, e.message);
  }
}

// RESET
async function doReset() {
  uiSetText(msg,"");

  try {
    const email = emailEl.value.trim();

    if(!email)
      throw new Error("Enter email first");

    await resetPassword(email);

    uiToast("Reset email sent");

  } catch(e) {
    uiSetText(msg, e.message);
  }
}

// BUTTONS
btnLogin.onclick = doLogin;
btnRegister.onclick = doRegister;
btnReset.onclick = doReset;

// GOOGLE
btnGoogle.onclick = async () => {
  try {
    await signInGoogle();
    await goNextByRole();
  } catch(e) {
    uiSetText(msg,e.message);
  }
};

// ENTER KEY
passEl.addEventListener("keydown", e=>{
  if(e.key==="Enter") doLogin();
});

</script>

</body>
</html>
